<!DOCTYPE html>
<html lang="en">
	<head>

		<title>matcap upload</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">

		<script src="/js/jquery.min.js"></script> 
		<script src="/js/bootstrap.min.js"></script>

		<script src="/js/Objectid.js"></script>
		<script src="/js/zangodb.min.js"></script>

		<style>

			body {
				font-family: sans-serif;
				font-size: 13px;
				background-color: #fff;
				margin: 0px;
				overflow: hidden;
			}

			.middle > * {
				position:absolute;
				height:fit-content;
				width:fit-content;
				top:0; bottom:0;
				left:0; right:0;
				margin:auto;
			}

		</style>

	</head>


	<body class="middle" ontouchstart="">

		<script>
/*
		//	UPLOADED MATCAPS:

		//	2048px:	   "MZV8PzS,L509oY2,Bw7q38p,2FA0yx1,vVDGl7g,3nmnKd4,E36SPOB,MXqauTz,YHsPLdq,soRJv4a"

		//	512px:	   "bixnsMm,MS1GDja,pUytALG,4KwC8wH,Wiqsp9s,gXRFY3U,2tkhy7C,D64zaTR,Id8k2u4,Fx9154f,
						dqKYFPo,l0Lf1LN,7bH7Ajw,IeAwKEi,VysdwUU,dWAhf12,9ufYr2S,iAWd8i1,mkGDAn5,gf3PsvD,
						BeHwxKA,GYBQ8Xr,9gxylAS,0p2RT39,aHeUCko,epbmrGs,NKMFDGB,pvXMCj9,QbZ8H2v,aCAVXQb,
						qU0AEUM,yvwt1wj,D5UeFcC,6GZMeko,rSlm3oM,Xqg7n0A,PzHZLHy,MEzwCJq,wgf7Vl0,GcLQiey,
						3xH34nj,vhdhgMe,jRTIv3l,xELCxlQ,wtJaViy,Qb0qKtc,7kq8wQ3,F6kcile,0LRxFql,rxUXS8C"

		//	missing:   "matcap_003.jpg,matcap_007.jpg,matcap_008.jpg,matcap_010.jpg,matcap_011.jpg,matcap_012.jpg,
						matcap_013.jpg,matcap_014.jpg,matcap_027.jpg,matcap_028.jpg,matcap_029.jpg,matcap_030.jpg,
						matcap_031.jpg,matcap_032.jpg,matcap_033.jpg,matcap_034.jpg,matcap_035.jpg,matcap_036.jpg,
						matcap_037.jpg,matcap_038.jpg,matcap_047.jpg,matcap_050.jpg,matcap_051.jpg,matcap_052.jpg,
						matcap_053.jpg,matcap_054.jpg,matcap_055.jpg,matcap_056.jpg,matcap_057.jpg,matcap_058.jpg,
						matcap_060.jpg,matcap_063.jpg,matcap_064.jpg,matcap_065.jpg,matcap_066.jpg,matcap_067.jpg,
						matcap_068.jpg,matcap_069.jpg,matcap_070.jpg,matcap_071.jpg,matcap_072.jpg,matcap_073.jpg,
						matcap_074.jpg,matcap_075.jpg,matcap_077.jpg,matcap_079.jpg,matcap_080.jpg,matcap_081.jpg,
						matcap_082.jpg,matcap_083.jpg,matcap_084.jpg,matcap_085.jpg,matcap_086.jpg,matcap_087.jpg,
						matcap_091.jpg,matcap_093.jpg,matcap_094.jpg,matcap_096.jpg,matcap_097.jpg,matcap_098.jpg"

*/

		//	const clientID = "06217f601180652";
		//	const endpoint = "https://api.imgur.com/3/image/"

			var matcaps;
			var input, button;
			var uploads, results;
			var debugMode = true;

			input = document.createElement("input");
			input.type = "file";
			input.style.display = "none";
			input.setAttribute( "multiple", "" ); // true.
			input.addEventListener( "change", function onChange(){

				console.log( input.files );
				if ( !input.files.length ) return;

				input.removeEventListener( "change", onChange );

				uploads = [];
				results = [];
				
				for (var i = 0; i < input.files.length; i++ ){
					(function(file){
						uploads.push( function(){
							return uploadTexture( file )
							.then(function( data ){
								results.push( data );
							}).catch(function(err){
								console.error(err);
							});
						});
					})( input.files[i] );
				}
				
				debugMode && console.log( "uploads:", uploads );

				var promises = [];

				while ( uploads.length ){
					promises.push( uploads.shift().call() );
				}

				Promise.all(promises).then(function(){

				//	debugMode && console.log( "results:", results );

					matcaps = results.map( function( item ){ 
						return item.id; 
					}).filter(Boolean);

					debugMode && console.log( matcaps );
					console.log( "matcaps:",  matcaps.join(",") );

				}).then(function(){

					var failed = results.filter(function(item){ 
						return item.error && item.file;
					}).map(function(item){
						return item.file;
					}).filter(Boolean).sort();
					
					if ( failed.length )
						console.log( {failed:failed.length, files:failed.join(",")} );
					else
						console.log("All files uploaded successfully.");

				}).catch(function(err){
					console.error(err);
				}).then( function(){
					input.addEventListener( "change", onChange );
				});

			});

			button = document.createElement("a");
			button.text = "Choose matcaps";
			button.classList.add("btn", "btn-primary");
			button.addEventListener("click", function(){
				input.value = "";
				input.click();
				console.clear();
				return false;
			});

			document.body.appendChild( button );

			function uploadTexture(file){
			//  Returns a resolved promise with record data from imgur.com.
				debugMode && console.log(`uploading ${file.name}...`);
				return new Promise(function( resolve, reject ){

					var formdata = new FormData();
					formdata.append("image", file);
					formdata.append("type",  file.type);
					formdata.append("name",  file.name);

					var xhttp = new XMLHttpRequest();
					var clientid = "06217f601180652";  // slothes app.
					var endpoint = "https://api.imgur.com/3/image";
					xhttp.open("POST", endpoint, true);
					xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
					xhttp.onreadystatechange = function () {
						if (this.readyState === 4) {
							var response = "";
							if (this.status >= 200 && this.status < 300) {
								response = JSON.parse(this.responseText);
								debugMode && console.log(response.data);
								resolve(response.data); // resolve promise.
							} else {
								var err = JSON.parse(this.responseText).data.error;
								console.error( err.type, err );
								resolve( {file:file.name, error:err.type, message:err} ); // throw err;
							}
						}
					};

					xhttp.send(formdata);
					xhttp = null;
				});
			}

		</script>

	</body>
</html>
