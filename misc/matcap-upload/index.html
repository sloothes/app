<!DOCTYPE html>
<html lang="en">
	<head>

		<title>matcap upload</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">

		<script src="/js/jquery.min.js"></script> 
		<script src="/js/bootstrap.min.js"></script>

		<script src="/js/Objectid.js"></script>
		<script src="/js/zangodb.min.js"></script>

		<style>

			body {
				font-family: sans-serif;
				font-size: 13px;
				background-color: #fff;
				margin: 0px;
				overflow: hidden;
			}

			.middle > * {
				position:absolute;
				height:fit-content;
				width:fit-content;
				top:0; bottom:0;
				left:0; right:0;
				margin:auto;
			}

		</style>

	</head>


	<body class="middle" ontouchstart="">

		<script>

		//	const clientID = "06217f601180652";
		//	const endpoint = "https://api.imgur.com/3/image/"

			var input = document.createElement("input");
			input.type = "file";
			input.style.display = "none";
			input.setAttribute( "multiple", "" ); // true.
			input.addEventListener( "change", function onChange(){

				console.log( input.files );
				if ( !input.files.length ) return;
				
				input.removeEventListener( "change", onChange );

				var uploads = [];
				var results = [];
				
				for (var i=0; i < input.files.length; i++ ){
					uploads.push( 
						uploadTexture( input.files[i] )
						.then(function( data ){
							results.push( data );
						}).catch(function(err){
							console.error(err);
						})
					);
				}
				
				console.log( uploads );
				
				return; // breakpoint.

			/*
				Promise.all(uploads).then(function(){

				//	console.log( results );

					var imgurIds = results.map( function( item ){
						return item.id;
					});
					
					console.log( imgurIds );
					console.log( imgurIds.join(",");

				}).catch(function(err){
					console.error(err);
				}).then( function(){
					input.addEventListener( "change", onChange );
				});
			*/

			});

			var button = document.createElement("a");
			button.text = "Choose matcaps";
			button.classList.add("btn", "btn-primary");
			button.addEventListener("click", function(){
				input.value = "";
				input.click();
				return false;
			});

			document.body.appendChild( button );


			function uploadTexture(file){
			//  Returns a resolved promise with record data from imgur.com.
				debugMode && console.log(`uploading ${file.name}...`);
				return new Promise(function( resolve, reject ){

					var formdata = new FormData();
					formdata.append("image", file);
					formdata.append("type",  file.type);
					formdata.append("name",  file.name);

					var xhttp = new XMLHttpRequest();
					var clientid = "06217f601180652";  // slothes app.
					var endpoint = "https://api.imgur.com/3/image";
					xhttp.open("POST", endpoint, true);
					xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
					xhttp.onreadystatechange = function () {
						if (this.readyState === 4) {
							var response = "";
							if (this.status >= 200 && this.status < 300) {
								response = JSON.parse(this.responseText);
								debugMode && console.log(response.data);
								resolve(response.data); // resolve promise.
							} else {
								var err = JSON.parse(this.responseText).data.error;
								console.error( err.type, err );
								resolve( {file:file.name, error:err.type, message:err} ); // throw err;
							}
						}
					};

					xhttp.send(formdata);
					xhttp = null;
				});
			}

		</script>

	</body>
</html>
