<!DOCTYPE html>
<html lang="en">
	<head>

		<title>matcap upload</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">

		<script src="/js/jquery.min.js"></script> 
		<script src="/js/bootstrap.min.js"></script>

		<script src="/js/Objectid.js"></script>
		<script src="/js/zangodb.min.js"></script>

		<style>

			body {
				font-family: sans-serif;
				font-size: 13px;
				background-color: #fff;
				margin: 0px;
				overflow: hidden;
			}

			.middle > * {
				position:absolute;
				height:fit-content;
				width:fit-content;
				top:0; bottom:0;
				left:0; right:0;
				margin:auto;
			}

		</style>

	</head>


	<body class="middle" ontouchstart="">

		<script>

			var matcaps;
			var input, button;
			var uploads, results;
			var debugMode = true;

		//	MATCAPS
		//	2K: "MZV8PzS,L509oY2,Bw7q38p,2FA0yx1,vVDGl7g,3nmnKd4,E36SPOB,MXqauTz,YHsPLdq,soRJv4a".
			
		//	const clientID = "06217f601180652";
		//	const endpoint = "https://api.imgur.com/3/image/"

			input = document.createElement("input");
			input.type = "file";
			input.style.display = "none";
			input.setAttribute( "multiple", "" ); // true.
			input.addEventListener( "change", function onChange(){

				console.log( input.files );
				if ( !input.files.length ) return;

				input.removeEventListener( "change", onChange );

				uploads = [];
				results = [];
				
				for (var i = 0; i < input.files.length; i++ ){
					(function(file){
						uploads.push( function(){
							return uploadTexture( file )
							.then(function( data ){
								results.push( data );
							}).catch(function(err){
								console.error(err);
							});
						});
					})( input.files[i] );
				}
				
				debugMode && console.log( "uploads:", uploads );
				return input.addEventListener( "change", onChange ); // breakpoint.

			});

			/*
				Promise.all(uploads).then(function(){

				//	debugMode && console.log( "results:", results );

					matcaps = results.map( function( item ){ 
						return item.id; 
					});

					debugMode && console.log( matcaps );
					console.log( "matcaps:", matcaps.join(",") );

				}).catch(function(err){
					console.error(err);
				}).then( function(){
					input.addEventListener( "change", onChange );
				});
			*/

			button = document.createElement("a");
			button.text = "Choose matcaps";
			button.classList.add("btn", "btn-primary");
			button.addEventListener("click", function(){
				input.value = "";
				input.click();
				console.clear();
				return false;
			});

			document.body.appendChild( button );

			function uploadTexture(file){
			//  Returns a resolved promise with record data from imgur.com.
				debugMode && console.log(`uploading ${file.name}...`);
				return new Promise(function( resolve, reject ){

					var formdata = new FormData();
					formdata.append("image", file);
					formdata.append("type",  file.type);
					formdata.append("name",  file.name);

					var xhttp = new XMLHttpRequest();
					var clientid = "06217f601180652";  // slothes app.
					var endpoint = "https://api.imgur.com/3/image";
					xhttp.open("POST", endpoint, true);
					xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
					xhttp.onreadystatechange = function () {
						if (this.readyState === 4) {
							var response = "";
							if (this.status >= 200 && this.status < 300) {
								response = JSON.parse(this.responseText);
								debugMode && console.log(response.data);
								resolve(response.data); // resolve promise.
							} else {
								var err = JSON.parse(this.responseText).data.error;
								console.error( err.type, err );
								resolve( {file:file.name, error:err.type, message:err} ); // throw err;
							}
						}
					};

					xhttp.send(formdata);
					xhttp = null;
				});
			}

		</script>

	</body>
</html>
